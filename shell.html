<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>vc64web</title>
  
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/vc64.css">
  <script src="js/jquery-3.5.0.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/vC64Storage.js"></script>
  <script src="vC64helper.js"></script>
  <script src="vC64keymap.js"></script>
    <style>
      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      textarea.emscripten { font-family: monospace; width: 80%; }
      div.emscripten { text-align: center; }
      div.emscripten_border { border: 0px solid black; }
      /* the canvas *must not* have any border or padding, or mouse coords will be wrong */
      canvas.emscripten 
      { border: 0px none; background-color: black; }
      .spinner {
        height: 50px;
        width: 50px;
        margin: 0px auto;
        -webkit-animation: rotation .8s linear infinite;
        -moz-animation: rotation .8s linear infinite;
        -o-animation: rotation .8s linear infinite;
        animation: rotation 0.8s linear infinite;
        border-left: 10px solid rgb(0,150,240);
        border-right: 10px solid rgb(0,150,240);
        border-bottom: 10px solid rgb(0,150,240);
        border-top: 10px solid rgb(100,0,200);
        border-radius: 100%;
        background-color: rgb(200,100,250);
      }
      @-webkit-keyframes rotation {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
      }
      @-moz-keyframes rotation {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
      }
      @-o-keyframes rotation {
        from {-o-transform: rotate(0deg);}
        to {-o-transform: rotate(360deg);}
      }
      @keyframes rotation {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
      }
    </style>
  </head>
  <body data-theme="dark">
    <figure style="overflow:visible;" id="spinner"><div class="spinner"></div><center style="margin-top:0.5em"><strong>emscripten</strong></center></figure>
    <div class="emscripten" id="status">Downloading...</div>
    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1></progress>  
    </div>

    <div id="div_canvas" class="emscripten_border">
      <canvas class="emscripten" width="428" height="284" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
    </div>
    <!-- virtual keyboard-->
    <!-- 
      we pin the keyboard collapsable at the bottom and give it the full width 
    -->
    <div class="collapse" id="virtual_keyboard">
      <div class="justify-content-center"
        style="display: flex;flex-wrap: nowrap;overflow-x: auto;">
        <div style="flex: 0 0 auto;padding-right: 15px;padding-left: 15px;position: relative;min-width: 0;max-width: 100%;">
          <!-- 
            the following absolute width defines the scrollable area
            if it is to short then some keys on the outer egdes are clipped
          -->
          <div style="width:750px;" id="divKeyboardRows"></div>      
        </div>
      </div>
    </div>



    <button id="button_show_menu" 
    style="position: fixed; top:0; left:0;z-index:200;" 
    type="button" class="btn btn-sm icon mt-2"
    data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"
    >
      <svg class="bi bi-list" width="1.6em" height="auto" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" d="M2.5 11.5A.5.5 0 0 1 3 11h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 7h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 3h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
      </svg>
    </button>
  
    <div class="container-fluid collapse" 
      style="position: fixed; top:0; left:0; opacity: 0.95;backdrop-filter: blur(6px);"
      id="navbar">
    <div class="row mt-2 mb-1">
    <div class="col-8" style="padding-left:0">
        <span style="width: 40px;display: inline-block;"></span>
        <button type="button" id="button_reset" class="btn btn-sm icon" data-toggle="tooltip" data-placement="top" title="reset">
          <svg class="bi bi-skip-start-fill" width="1.6em" height="auto" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M4.5 3.5A.5.5 0 0 0 4 4v8a.5.5 0 0 0 1 0V4a.5.5 0 0 0-.5-.5z"/>
            <path d="M4.903 8.697l6.364 3.692c.54.313 1.232-.066 1.232-.697V4.308c0-.63-.692-1.01-1.232-.696L4.903 7.304a.802.802 0 0 0 0 1.393z"/>
          </svg>
        </button>
        <span class="d-inline-block" data-toggle="tooltip" data-placement="top" title="pause">
        <button type="button" id="button_halt" class="btn btn-sm icon">
          <svg class="bi bi-pause-fill" width="1.6em" height="auto" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
          </svg>
        </button>
        </span> 
        <span class="d-inline-block" data-toggle="tooltip" data-placement="top" title="run">
        <button type="button" id="button_run" class="btn btn-sm icon" disabled>
          <svg class="bi bi-play-fill" width="1.6em" height="auto" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
          </svg>
        </button>
        </span>      
      <button type="button" id="button_take_snapshot" class="btn btn-sm icon mr-1" data-toggle="tooltip" data-placement="top" title="take snaphot">
        <svg class="bi bi-box-arrow-in-down" width="1.6em" height="auto" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M4.646 8.146a.5.5 0 0 1 .708 0L8 10.793l2.646-2.647a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 0-.708z"/>
          <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-1 0v-9A.5.5 0 0 1 8 1z"/>
          <path fill-rule="evenodd" d="M1.5 13.5A1.5 1.5 0 0 0 3 15h10a1.5 1.5 0 0 0 1.5-1.5v-8A1.5 1.5 0 0 0 13 4h-1.5a.5.5 0 0 0 0 1H13a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5v-8A.5.5 0 0 1 3 5h1.5a.5.5 0 0 0 0-1H3a1.5 1.5 0 0 0-1.5 1.5v8z"/>
        </svg>
      </button>
      <span data-toggle="modal" data-target="#snapshotModal">
        <button type="button" id="button_snapshots" class="btn btn-sm icon mr-1" data-toggle="tooltip" data-placement="top" title="snapshot browser">
          <svg class="bi bi-collection-fill" width="1.6em" height="auto" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <rect width="16" height="10" rx="1.5" transform="matrix(1 0 0 -1 0 14.5)"/>
            <path fill-rule="evenodd" d="M2 3a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 0-1h-11A.5.5 0 0 0 2 3zm2-2a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 0-1h-7A.5.5 0 0 0 4 1z"/>
          </svg>
        </button>
      </span>
      <span data-toggle="collapse" data-target="#virtual_keyboard" aria-expanded="false" aria-controls="virtual_keyboard">
        <button id="button_keyboard" class="btn btn-sm icon mr-1" type="button" data-toggle="tooltip" data-placement="top" title="virtual keyboard">
          <svg class="bi bi-type" width="1.6em" height="auto" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.244 13.081l.943-2.803H6.66l.944 2.803H8.86L5.54 3.75H4.322L1 13.081h1.244zm2.7-7.923L6.34 9.314H3.51l1.4-4.156h.034zm9.146 7.027h.035v.896h1.128V8.125c0-1.51-1.114-2.345-2.646-2.345-1.736 0-2.59.916-2.666 2.174h1.108c.068-.718.595-1.19 1.517-1.19.971 0 1.518.52 1.518 1.464v.731H12.19c-1.647.007-2.522.8-2.522 2.058 0 1.319.957 2.18 2.345 2.18 1.06 0 1.716-.43 2.078-1.011zm-1.763.035c-.752 0-1.456-.397-1.456-1.244 0-.65.424-1.115 1.408-1.115h1.805v.834c0 .896-.752 1.525-1.757 1.525z"/>
          </svg>
        </button></span>
      <button id="button_settings" class="btn btn-sm icon mr-1" type="button" data-toggle="modal" data-target="#modal_settings">
        <svg class="bi bi-gear-fill" width="1.6em" height="auto" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 0 0-5.86 2.929 2.929 0 0 0 0 5.858z"/>
        </svg>
      </button>
      <form id="theFileInput" style="display: inline-block;">
        <div id="drop_zone" class="px-2 u-full-width" data-toggle="tooltip" data-placement="bottom" title="drop .g64 .d64 .crt, .prg or .bin files into here, or just click into the drop zone">
          file slot
        </div>
        <!-- iOS won't work with accept=".g64,.d64,.crt,.prg,.bin" on d64 files -->
        <input id="filedialog" name="theFileDialog" type="file" style="display:none" >
      </form>
       
    </div>
    <div class="col-4">
      <select id="port1" class="custom-select mr-1" data-toggle="tooltip" data-placement="left" title="game port 1">
        <option value="none">none</option>
        <option value="keys">cursor keys, space to fire</option>        
      </select>
      <select id="port2" class="custom-select" data-toggle="tooltip" data-placement="left" title="game port 2">
        <option value="none">none</option>
        <option value="keys">cursor keys, space to fire</option>        
      </select>
    </div>
    </div>      
  
    <div class="row mt-1" id="output_row">
    <div class="col-12">
      <textarea rows="20" id="output"></textarea>
    </div>
    </div>
    </div> <!-- end of fluid container -->


    <!-- Modal snapshot-->
    <div class="modal fade" id="snapshotModal" tabindex="-1" role="dialog" aria-labelledby="snapshotModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="snapshotModalLabel">snapshots</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
          <div id="container_snapshots" class="container scrollx-group">
          </div><!-- container end-->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- end of Modal snapshot-->

    <!-- modal roms-->
    <div class="modal fade" id="modal_roms" tabindex="-1" role="dialog" aria-labelledby="snapshotModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="snapshotModalLabel">ROMS</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            The emulator needs four rom files.<br>
            If you see a black screen then these rom files have not been loaded
            to VirtualC64web yet. 
            <br><br>
            Close this message and drag <br>
            <ul>
            <li>kernal_rom.bin</li>
            <li>charset_rom.bin</li>
            <li>basic_rom.bin</li>
            <li>vc1541_rom.bin</li>
            </ul>

            into the blue bordered disk file box. VirtualC64web will try to store these files to your browsers local storage. Then on subsequent starts it will take the rom files from your browsers local storage instead of asking you again for them.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- end of modal roms-->

    <!-- modal settings-->
    <div class="modal fade" id="modal_settings" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="settingsModalLabel"><img src="vc64web.png" style="height: 50px;" /> settings</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>your settings will be saved to your local browser storage</p>
            
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="cb_debug_output" />
              <label class="custom-control-label" for="cb_debug_output">show live debug output</label>
            </div>
            <div class="custom-control custom-switch mt-1">
              <input type="checkbox" class="custom-control-input" id="dark_switch" />
              <label class="custom-control-label" for="dark_switch">dark mode</label>
            </div>
            <div class="custom-control custom-switch mt-1" >
              <input type="checkbox" class="custom-control-input" id="pixel_art_switch"/>
              <label class="custom-control-label" for="pixel_art_switch"  data-toggle="tooltip" data-placement="right" title="on safari webgl must be deactivated for pixel art">pixel art</label>
            </div>
            <div class="custom-control custom-switch mt-1">
              <input type="checkbox" class="custom-control-input" id="webgl_switch" />
              <label class="custom-control-label" for="webgl_switch">on next start use accelerated WebGL</label>
            </div>
            <div class="custom-control custom-switch mt-1">
              <input type="checkbox" class="custom-control-input" id="warp_switch" />
              <label class="custom-control-label" for="warp_switch">warp during disk load</label>
            </div>
            <hr>
            <div class="mt-3" style="font-size: small;">
            <p>
              VirtualC64web emulates a cycle-acurate Commodore 64 on the web. 
              <br><br>
              for more information see here
              <br>
              <a href="https://github.com/dirkwhoffmann/virtualc64">
                https://github.com/dirkwhoffmann/virtualc64</a>
              <br><br>
              and on the web port specfic site of this project
              <br>
              <a href="https://github.com/dirkwhoffmann/virtualc64web">
              https://github.com/dirkwhoffmann/virtualc64web</a>
            </p>
          </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- end of modal settings-->



    <script type='text/javascript'>
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');
      var spinnerElement = document.getElementById('spinner');

      live_debug_output=load_setting('live_debug_output', false);
      var Module = {
        preRun: [],
        postRun: [InitWrappers],
        print: (function() {
          var element = document.getElementById('output');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            if(!live_debug_output)
            return;

            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            // These replacements are necessary if you render to raw HTML
            //text = text.replace(/&/g, "&amp;");
            //text = text.replace(/</g, "&lt;");
            //text = text.replace(/>/g, "&gt;");
            //text = text.replace('\n', '<br>', 'g');
            console.log(text);
            if (element) {
              element.value += text + "\n";
              element.scrollTop = element.scrollHeight; // focus on bottom
            }
          };
        })(),
        printErr: function(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
          console.error(text);
        },
        canvas: (function() {
          var canvas = document.getElementById('canvas');

          // As a default initial behavior, pop up an alert when webgl context is lost. To make your
          // application robust, you may want to override this behavior before shipping!
          // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
          canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

          return canvas;
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.last.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
            spinnerElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
            if (!text) spinnerElement.hidden = true;
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
      window.onerror = function() {
        Module.setStatus('Exception thrown, see JavaScript console');
        spinnerElement.style.display = 'none';
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };

      var db;    
      //ready function
      $(function () {
        $('[data-toggle="popover"]').popover();
        //$('[data-toggle="tooltip"]').tooltip();
        $("body").tooltip({selector: '[data-toggle="tooltip"]'});
  
        initDB();
      })

    </script>
    {{{ SCRIPT }}}
  </body>
</html>
